# 金融计算器

## 项目概述
基于Vue3框架，我们开发了一款网页式金融计算器，它包含科学计算器、投资/贷款计算器、现金流计算器、储蓄计算器、货币汇率转化计算器、税务计算器六大部分。每个计算器均可以通过全局设置进行结果的精度显示更改与货币类型显示更改，并且具有清空输入，以及将计算结果保存到历史记录的功能。

### 科学计算器

计算部分支持简单四则运算、小数计算、圆周率和自然对数的输入、次方运算、绝对值运算、对数运算、根式运算、倒数运算、三角函数与反三角函数运算、输入括号以改变运算顺序、阶乘运算、排列数、组合数运算等功能；除此以外，本计算器支持角度/弧度制转化，兼容鼠标输入和键盘输入，并且支持计算结果的小数分数显示转化。用户可以在科学计算器部分基本实现日常所需的初等数学计算功能。

### 投资/贷款计算器

实现现值PV、终值FV、每期付款/收益PMT、贴现率I/Y、期数N五个参数的知四求一功能，对一个投资计划中的五个参数都可以进行计算，并同时显示计划的总利息和所有定期支付的总和，并且引入了灵敏度分析，可以给用户呈现出投资项目承担风险的能力。用户可以通过投资/贷款计算器轻松计算与规划投资/贷款计划。

### 现金流计算器
分为周期性现金流和不规则现金流。

#### 周期性现金流

输入贴现率，添加现金流的现金流入/支出数据（支持一键取相反数）与频数数据，本现金流计算器将自动进行现金流可视化，直观展示现金流情况，输出项目的净现值、内部收益率和盈利指数以判断盈利情况，并对结果同样进行灵敏度分析。支持一键删除单条现金流或全部现金流，输入便捷，功能齐全。

#### 自定义现金流

在日期的输入上更加自由，以天为单位，可以更好的细化管理与分析短期高频的现金流情况。同样支持便捷的数据更改、可视化与灵敏度分析。

### 储蓄计算器

支持活期、定活两便、存本取息、零存整取、整存整取五种存款方式的利息和本息和计算。用户选择存款方式，输入或选择存款时长，输出年利率、总利息和最终储蓄金额（本息和）。本储蓄计算器完全根据我国银行存款规则进行计算。

### 货币汇率转化计算器

支持不同国家地区币种间的汇率转化。用户输入金额数，选择原币种和转化后币种，输出转化后的金额数与汇率。

### 税务计算器

#### 五险一金

输入单月税前工资，根据上海当地的基数范围自动计算社保基数和住房公积金基数，再根据社会保险金占比和公积金占比计算所需的个人缴纳金额，其中各项占比可以默认输入也支持用户自己输入，最终输出各项保额与五险一金总额。

#### 个税计算器

根据我国个税规定，输入当前月份、税前工资、五险一金（五险一金计算器自动计算或手动输入）、专项附加扣除、其他扣除，自动计算或手动输入上述五个参数金额的当年总计（自动计算默认每月金额相等），计算出当年应纳税所得额、累计应纳税额与除此月外的应纳税所得额、税率、当月个税与当月税后工资。


除计算器部分以外，本网页还进行了首页设计、开发使用手册以指导用户使用以及全局设置的开发。
在功能多样性、完整性、用户体验性和便捷性上，我们进行了大量的工作，如菜单栏的路由跳转显示设置、选择框的选择显示效果、全局设置与个税月份滑框的美化、科学计算器按钮悬停特效、净现值动态显示、日间/夜间模式切换、回到顶部按钮、菜单栏折叠等。这些工作以及功能在下面的需求、功能实现与开发过程等部分进行展示。

## 项目背景与目标回顾

项目灵感始于我校财经院校的金融氛围。金融计算器对于商科、金融学专业的学生是不可缺少的工具，而网页式的金融计算器不仅能够实现简单的金融计算功能，也可以帮助个人在储蓄、投资、理财等方面进行帮助，最重要的是只需一台计算机和浏览器，而计算机几乎是学生、社会人士的必备工具，因此本项目的目标受众既可以是需要科学计算与金融计算的学生，也可以是对金融方面有需求的社会人士。


开发过程中实现的功能除了实现项目初始制定的功能计划，也包括了许多使用便捷程度方面的需求，例如暗色模式作为网站常有的护眼功能，历史记录作为计算器的一个十分便捷的功能，兼容输入、精度调整、显示模式、弧度角度制转化等科学计算器的附加使用功能以及可视化、灵敏度分析在金融项目中的重要作用。其中计算结果导出为表格文件在开发过程中认为较为冗余，故删去，截至目前，立项的所有功能均已完成。

## 系统架构与技术实现

项目采用了最前沿的web前端开发技术。项目整体基于vue3框架，采用组合式api，实现更好的模块解耦。在语言上选择了TypeScipt，提升了类型安全和项目的可维护性。接下来从**视图层**、**业务层**和**数据层**对本项目的系统架构进行介绍：

### 视图层

本项目注重ui设计和用户的交互体验。本项目整体上使用了naive-ui组件库，使用ECharts图表库对相关数据进行可视化；使用Gsap动画库提供更流畅的交互体验（例如数字递增特效）；使用xicons图标库，ui更整洁美观；使用katex公式渲染库，更优美得展示数学表达式。我们写了两套css主题（白天模式和暗黑模式）满足不同用户的喜好需求。

### 业务层

本项目采纳了一些优秀的金融函数库，例如：financejs、xirr等，也自行编写了各种金融函数（npv、irr、知四求一、个税、五险一金等），同时采用了mathjs满足科学运算的场景。
在开发过程中，我们考虑到本项目的功能多样性、业务复杂性会增加未来的维护和扩展开销，因此我们采用了vitest测试框架对编写的金融函数进行单元测试并保留了测试文件，确保了项目的可监控、可回滚。
我们采用git进行项目的版本分支管理，并采用了双分支开发模式，使用main分支作为稳定版本，使用dev分支作为灰度版本（开发版本），使得开发进程有序平稳地进行。
在项目上线过程中，我们采用最新的vite构建工具进行项目的打包，选取高性能的前端服务器NGINX作为部署载体，目前网站已经可以在公网环境下正常访问，网页地址：http://101.43.48.148/。

### 数据层

本项目考虑到数据的轻量性和非关键性，本项目的所有数据均在浏览器本地存储，未设置后端数据库。我们综合使用了localStorage和sessionStorage来存储用户数据，并采用pinia状态管理库进行集中式管理。对于用户的输入数据和结果数据，我们通过sessionStorage进行临时会话存储，保证用户在路由跳转、刷新页面的过程中输入数据和结果数据不丢失。对于用户的个人偏好（明暗主题等）、全局设置、历史记录数据，我们通过localStorage进行持久化存储，确保用户即使关闭浏览器后，再次使用依然可以保留原有数据。采用浏览器本地存储，减少了带宽开销和传输延时，用户也可以有更流畅、更个性化、更隐私安全的使用体验。

## 项目结构介绍

- public: 公共静态资源文件
- src: 源文件
  - @types: 类型声明文件
  - assets：静态资源文件
    - icon: 图标文件
    - picture：图片文件
  - components: vue组件文件
  - constants：管理常量的文件（全局配置、提示消息等）
  - router: 路由文件
  - stores：pinia状态管理文件
    - input: 存储输入数据
    - result: 存储输出文件
    - historyStore.ts: 存储历史记录
    - settingStore.ts: 存储全局设置
    - themeStore: 存储主题状态变量
  - types: 自定义类型文件
  - utils: 工具函数文件
  - views：视图组件文件
  - App.vue: 祖宗组件
  - main.ts: vue入口文件
- test: 测试用例文件
- index.html: 项目入口文件
- package.json/package.json: 第三方依赖信息、项目版本信息等
- tsconfig.json: TypeScript 配置文件
- vite.config.ts: vite配置文件

## 测试结果与质量保证
以下是我们部分的bug和解决方案的统计，小bug忽略不计。

Bug：使用手册切换回计算器以后科学计算器按钮与公式渲染丢失。

解决方案：考虑为使用手册使用Katex渲染导致冲突（全局导入katex样式而不是局部导入导致样式冲突，计算器页面的公式无法渲染），将样式导入改为局部导入，当路由定向至计算器页面时重新进行公式渲染，问题不再出现。
---
Bug: 从别的页面跳转到科学计算器页面时，此时按下热键会有重复触发的问题

解决方案：使用onUnMounted的hook，在页面销毁时对热键进行解绑，再重新回到该页面时再重新挂载热键，就不会有重复触发问题
---
Bug: 从历史记录跳转到另一个计算器，侧边栏的active项不会跟着改变

解决方案：由于路由之间是单向绑定的原因，点击侧边栏，先将对应项变为active，再跳转到对应页面，但是反之无法成立。要实现路由与activeKey的双向绑定，我们再路由配置文件中为每个计算器组件添加了一个meta值（activeKey）。并在每个侧边栏组件上写一个监听器来侦听路由变化，一旦变化就将meta中的activeKey赋值给侧边栏的activeKey
---
Bug: 再历史记录的存取过程中，发现数组、对象类型的数据存储中会有被覆盖的问题。

解决方案：数组、对象类型不同于基本类型，它属于引用类型变量，没有考虑到深拷贝和浅拷贝的问题。因此不能直接对引用类型变量进行存储，应当采用JSON.parse(JSON.stringfy(obj))的方式。


## 项目亮点

- 考虑到不同用户的偏好需求，设置了明暗两种主题。
- 对计算历史记录进行保存，并在浏览器本地存储。
- 功能众多，满足了不同场景的金融计算需求
- 设置了全局配置项，用户可以根据自己需求进行个性化使用
- 考虑了众多细节：（例如页面下拉到底会有返回顶部按钮、现金流设置了常用的取反按钮、热键在页面回显、有提示信息来防止用户犯错）
- 有使用手册，就算用户不了解金融领域，也可以通过本计算器进行学习
- 图表设置无障碍选项，考虑色盲人士，具有人文关怀